<!doctype html>
<html lang="de">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Local Video Hub ‚Äî Statisch (GitHub Pages)</title>
<meta name="description" content="Temp Video Hub - Lokal, statisch, IndexedDB - Upload, Playlist, Thumbnails, Comments, Likes" />
<style>
/* ===== Visuals (modern, responsive) ===== */
:root{
  --bg:#0b1220; --card:#0f1724; --muted:#98a4b3; --accent:#60a5fa; --glass:rgba(255,255,255,0.03);
  --max-width:1200px;
}
*{box-sizing:border-box}
html,body{height:100%;margin:0;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial;color:#e6eef6;background:linear-gradient(180deg,#071028,#071428);-webkit-font-smoothing:antialiased}
.container{max-width:var(--max-width);margin:18px auto;padding:12px}
.header{display:flex;gap:12px;align-items:center}
.header h1{margin:0;font-size:18px}
.header .spacer{flex:1}
.panel{background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));border-radius:12px;padding:12px;border:1px solid rgba(255,255,255,0.03);box-shadow:0 8px 30px rgba(2,6,23,0.6)}
.flex{display:flex;gap:12px}
.column{display:flex;flex-direction:column;gap:8px}
.row{display:flex;gap:8px;align-items:center}
.input,textarea,select{padding:8px;border-radius:8px;border:1px solid rgba(255,255,255,0.04);background:transparent;color:inherit}
.btn{padding:8px 12px;border-radius:8px;border:1px solid rgba(255,255,255,0.03);background:var(--glass);color:inherit;cursor:pointer}
.btn.primary{background:linear-gradient(90deg,#2b6cb0,var(--accent));border:none;color:white}
.btn.ghost{background:transparent;border:1px dashed rgba(255,255,255,0.04)}
.small{font-size:13px;color:var(--muted)}
.upload-area{border:2px dashed rgba(255,255,255,0.04);padding:12px;border-radius:10px;display:flex;gap:10px;align-items:center}
.grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(240px,1fr));gap:12px;margin-top:12px}
.card{border-radius:10px;overflow:hidden;border:1px solid rgba(255,255,255,0.03);background:linear-gradient(180deg, rgba(255,255,255,0.01), rgba(255,255,255,0.005))}
.thumb{width:100%;height:140px;object-fit:cover;background:#000;display:block;cursor:pointer}
.card-body{padding:10px}
.title{font-weight:700;margin:0;color:#eaf5ff;font-size:15px}
.desc{color:var(--muted);font-size:13px;margin:6px 0;height:40px;overflow:hidden}
.meta-row{display:flex;justify-content:space-between;align-items:center;gap:8px}
.controls{display:flex;gap:6px}
.playlist-badge{background:rgba(96,165,250,0.12);color:var(--accent);padding:4px 8px;border-radius:999px;font-size:12px}
.top-controls{display:flex;gap:8px;align-items:center}
.tools{display:flex;gap:6px;align-items:center}
.player-modal{position:fixed;left:50%;top:50%;transform:translate(-50%,-50%);width:92%;max-width:1100px;height:78vh;background:white;border-radius:10px;z-index:120;box-shadow:0 30px 80px rgba(2,6,23,0.6);display:flex;flex-direction:column;overflow:hidden}
.player-header{display:flex;align-items:center;gap:8px;padding:10px;border-bottom:1px solid #efefef}
.player-left{flex:2;background:#000;display:flex;align-items:center;justify-content:center}
.player-right{flex:1;padding:12px;overflow:auto;background:#fff;color:#111}
video{width:100%;height:100%;background:#000}
.close-x{margin-left:auto;cursor:pointer;font-weight:700}
.list{display:flex;flex-direction:column;gap:6px}
.item{display:flex;gap:8px;align-items:center;padding:8px;border-radius:8px}
.item:hover{background:rgba(0,0,0,0.03)}
.badge{padding:4px 8px;border-radius:999px;background:rgba(0,0,0,0.04);font-size:12px}
.controls .btn{padding:6px 8px}
.footer{margin-top:18px;color:var(--muted);font-size:13px;text-align:center;padding:8px}
/* responsive */
@media (max-width:980px){
  .flex.responsive{flex-direction:column}
  .player-modal{height:86vh}
}
</style>
</head>
<body>
<div class="container">
  <div class="header">
    <h1>Local Video Hub (statisch)</h1>
    <div class="spacer"></div>
    <div class="top-controls">
      <button id="toggleTheme" class="btn">Dark / Light</button>
      <button id="exportMeta" class="btn">Export Metadaten</button>
      <button id="importMeta" class="btn">Import Metadaten</button>
      <button id="cleanExpired" class="btn">Abgelaufene l√∂schen</button>
    </div>
  </div>

  <div style="height:12px"></div>

  <!-- Upload + controls -->
  <div class="panel flex responsive">
    <div style="flex:1" class="column">
      <div class="upload-area">
        <label class="btn ghost" for="fileInput">Datei ausw√§hlen</label>
        <input id="fileInput" type="file" accept="video/*" multiple style="display:none">
        <div style="flex:1">
          <input id="titleInput" class="input" placeholder="Titel (optional)">
          <textarea id="descInput" class="input" placeholder="Beschreibung (optional)" style="width:100%;margin-top:6px"></textarea>
          <div style="display:flex;gap:8px;margin-top:8px">
            <select id="ttlSelect" class="input" style="width:160px">
              <option value="24">24 Stunden</option>
              <option value="72">72 Stunden</option>
              <option value="168" selected>7 Tage</option>
              <option value="720">30 Tage</option>
              <option value="0">Nie automatisch l√∂schen</option>
            </select>
            <button id="addQueue" class="btn primary">Zur Upload-Queue</button>
            <button id="startUpload" class="btn">Hochladen</button>
            <button id="clearQueue" class="btn">Queue leeren</button>
          </div>
        </div>
        <div style="width:220px">
          <div class="small">Upload-Queue</div>
          <ol id="queue" style="margin:6px 0;padding-left:18px;color:var(--muted)"></ol>
        </div>
      </div>

      <div style="height:12px"></div>

      <div class="row" style="align-items:center">
        <input id="searchInput" class="input" placeholder="Suchen (Titel, Beschreibung)..." style="flex:1">
        <select id="sortSelect" class="input" style="width:160px">
          <option value="new">Neueste</option>
          <option value="old">√Ñlteste</option>
          <option value="title">Titel A‚ÜíZ</option>
          <option value="views">Meiste Views</option>
          <option value="likes">Meiste Likes</option>
        </select>
        <button id="newPlaylist" class="btn">Neue Playlist</button>
      </div>

      <div style="height:12px"></div>

      <div class="panel">
        <strong>Playlists</strong>
        <div id="playlists" style="margin-top:8px"></div>
      </div>
    </div>

    <div style="width:420px" class="column">
      <div class="panel" style="flex:1;min-height:260px;overflow:auto">
        <strong>Statistiken</strong>
        <div id="stats" class="small" style="margin-top:8px">Lade ‚Ä¶</div>
        <div style="margin-top:10px">
          <small class="small">Hinweis: Alles bleibt lokal im Browser (IndexedDB). F√ºr Teilen/Server braucht's ein Backend.</small>
        </div>
      </div>

      <div style="height:12px"></div>

      <div class="panel" style="flex:1;min-height:180px;overflow:auto">
        <strong>Aktuelle Queue</strong>
        <ul id="queueSmall" class="small" style="margin-top:8px"></ul>
      </div>
    </div>
  </div>

  <!-- Gallery -->
  <div class="panel" style="margin-top:12px">
    <div style="display:flex;justify-content:space-between;align-items:center">
      <strong>Galerie</strong>
      <div class="tools">
        <button id="showAll" class="btn">Alle anzeigen</button>
        <button id="toggleTheater" class="btn">Theater-Mode</button>
      </div>
    </div>

    <div id="gallery" class="grid" style="margin-top:12px"></div>
  </div>

  <div class="footer">Local Video Hub ‚Äî statisch ‚Ä¢ F√ºr GitHub Pages geeignet</div>
</div>

<!-- Player Modal -->
<div id="playerModal" style="display:none" class="player-modal" role="dialog" aria-modal="true">
  <div class="player-header">
    <strong id="playerTitle">Titel</strong>
    <div id="playerInfo" class="small" style="margin-left:8px"></div>
    <div class="close-x" id="closePlayer">‚úï</div>
  </div>
  <div style="display:flex;flex:1;overflow:hidden">
    <div class="player-left" id="playerLeft">
      <video id="playerVideo" controls playsinline></video>
    </div>
    <div class="player-right" id="playerRight">
      <div style="margin-bottom:8px">
        <div style="display:flex;gap:8px;align-items:center">
          <div id="playerStats" class="small"></div>
          <div class="spacer" style="flex:1"></div>
          <button id="togglePlaylistPlay" class="btn">‚ñ∂Ô∏é Playlist</button>
        </div>
        <div style="height:8px"></div>
        <div id="playerDesc" style="white-space:pre-wrap;color:#333"></div>
      </div>

      <div style="margin-top:8px">
        <div style="font-weight:700;margin-bottom:6px">Kapitel / Marker</div>
        <div id="markerList" class="list small" style="max-height:120px;overflow:auto"></div>
        <div style="display:flex;gap:8px;margin-top:6px">
          <input id="markerTime" class="input" placeholder="Zeit (s)" style="width:90px">
          <input id="markerLabel" class="input" placeholder="Label" style="flex:1">
          <button id="addMarker" class="btn">Hinzuf√ºgen</button>
        </div>
      </div>

      <div style="margin-top:12px">
        <div style="display:flex;gap:8px">
          <button id="likeBtn" class="btn">‚ô° Like</button>
          <button id="downloadBtn" class="btn">‚Üì Download</button>
          <button id="deleteBtn" class="btn">üóëÔ∏è L√∂schen</button>
        </div>
      </div>

      <div style="margin-top:12px">
        <div style="font-weight:700">Kommentare</div>
        <div id="comments" style="max-height:180px;overflow:auto;margin-top:8px"></div>
        <div style="display:flex;gap:8px;margin-top:8px">
          <input id="commentInput" class="input" placeholder="Kommentar..." style="flex:1">
          <button id="addComment" class="btn">Senden</button>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
/* Local Video Hub ‚Äî Single-file app
   - Client-side only (IndexedDB)
   - Features: upload, thumbnails, gallery, playlists, comments, likes, views, markers, TTL, export/import metadata
*/

/* ================= IndexedDB helpers ================= */
const DB = 'localVideoHub_v1';
const STORE = 'videos';
const STORE_PLAYLISTS = 'playlists'; // separate store for playlists
const STORE_META = 'meta';

function openDB(){
  return new Promise((res,rej)=>{
    const rq = indexedDB.open(DB, 2);
    rq.onupgradeneeded = e => {
      const db = e.target.result;
      if(!db.objectStoreNames.contains(STORE)){
        const st = db.createObjectStore(STORE, {keyPath:'id'});
        st.createIndex('by_date','createdAt',{unique:false});
        st.createIndex('by_expire','expireAt',{unique:false});
      }
      if(!db.objectStoreNames.contains(STORE_PLAYLISTS)){
        db.createObjectStore(STORE_PLAYLISTS,{keyPath:'id'});
      }
      if(!db.objectStoreNames.contains(STORE_META)){
        db.createObjectStore(STORE_META,{keyPath:'key'});
      }
    };
    rq.onsuccess = ()=> res(rq.result);
    rq.onerror = ()=> rej(rq.error);
  });
}
async function idbPut(storeName, obj){ const db = await openDB(); return new Promise((res,rej)=>{ const tx=db.transaction(storeName,'readwrite'); tx.objectStore(storeName).put(obj); tx.oncomplete=()=>res(); tx.onerror=()=>rej(tx.error); });}
async function idbGetAll(storeName){ const db = await openDB(); return new Promise((res,rej)=>{ const tx=db.transaction(storeName,'readonly'); const req=tx.objectStore(storeName).getAll(); req.onsuccess=()=>res(req.result); req.onerror=()=>rej(req.error); });}
async function idbGet(storeName, key){ const db = await openDB(); return new Promise((res,rej)=>{ const tx=db.transaction(storeName,'readonly'); const req=tx.objectStore(storeName).get(key); req.onsuccess=()=>res(req.result); req.onerror=()=>rej(req.error); });}
async function idbDelete(storeName, key){ const db = await openDB(); return new Promise((res,rej)=>{ const tx=db.transaction(storeName,'readwrite'); tx.objectStore(storeName).delete(key); tx.oncomplete=()=>res(); tx.onerror=()=>rej(tx.error); });}

/* ================= Utility functions ================= */
function uid(prefix='v'){ return prefix + '_' + Math.random().toString(36).slice(2,10); }
function niceBytes(bytes){
  if(!bytes) return '0 B';
  const units = ['B','KB','MB','GB','TB'];
  let i=0; while(bytes >= 1024 && i<units.length-1){ bytes/=1024; i++; }
  return (i<2?Math.round(bytes):bytes.toFixed(1)) + ' ' + units[i];
}
function fmtDate(ts){ return new Date(ts).toLocaleString(); }
function timeLeft(expireAt){
  if(!expireAt) return 'Nie';
  const diff = expireAt - Date.now();
  if(diff <= 0) return 'abgelaufen';
  const d = Math.floor(diff/86400000); const h = Math.floor((diff%86400000)/3600000);
  if(d>0) return `${d}d ${h}h`;
  const m = Math.floor((diff%3600000)/60000);
  return `${h}h ${m}m`;
}

/* ================= Thumbnail generation ================= */
function captureThumbnail(blob){
  return new Promise((res,rej)=>{
    const url = URL.createObjectURL(blob);
    const vid = document.createElement('video');
    vid.src = url; vid.muted = true; vid.playsInline = true; vid.preload = 'metadata';
    let cleaned = false;
    const cleanup = ()=>{ if(!cleaned){ try{ URL.revokeObjectURL(url); }catch(e){} vid.remove(); cleaned=true; } };
    vid.onloadeddata = () => {
      try{
        const ts = Math.min(1, Math.max(0.1, vid.duration/10));
        vid.currentTime = ts;
      }catch(e){ cleanup(); rej(e); }
    };
    vid.onseeked = () => {
      try{
        const canvas = document.createElement('canvas');
        const w = Math.min(640, vid.videoWidth || 640);
        canvas.width = w;
        canvas.height = Math.round(w * ((vid.videoHeight || 360) / (vid.videoWidth || 640)));
        const ctx = canvas.getContext('2d');
        ctx.drawImage(vid,0,0,canvas.width,canvas.height);
        canvas.toBlob(b => { cleanup(); res(b); }, 'image/jpeg', 0.8);
      }catch(e){ cleanup(); rej(e); }
    };
    vid.onerror = (e)=> { cleanup(); rej(e || new Error('Video load error')); };
  });
}

/* ================= App state + cache ================= */
let uploadQueue = []; // {id,file,title,desc,ttl}
let cacheURLs = {}; // id -> objectURL (video)
let currentVideoId = null;
let playingPlaylist = null;
let playlistPlayingIndex = 0;

/* ================= DOM refs ================= */
const fileInput = document.getElementById('fileInput');
const addQueueBtn = document.getElementById('addQueue');
const startUploadBtn = document.getElementById('startUpload');
const clearQueueBtn = document.getElementById('clearQueue');
const queueEl = document.getElementById('queue');
const queueSmall = document.getElementById('queueSmall');
const titleInput = document.getElementById('titleInput');
const descInput = document.getElementById('descInput');
const ttlSelect = document.getElementById('ttlSelect');
const gallery = document.getElementById('gallery');
const stats = document.getElementById('stats');
const searchInput = document.getElementById('searchInput');
const sortSelect = document.getElementById('sortSelect');
const newPlaylistBtn = document.getElementById('newPlaylist');
const playlistsEl = document.getElementById('playlists');
const playerModal = document.getElementById('playerModal');
const playerVideo = document.getElementById('playerVideo');
const playerTitle = document.getElementById('playerTitle');
const playerDesc = document.getElementById('playerDesc');
const playerInfo = document.getElementById('playerInfo');
const playerStats = document.getElementById('playerStats');
const markerList = document.getElementById('markerList');
const markerTime = document.getElementById('markerTime');
const markerLabel = document.getElementById('markerLabel');
const addMarkerBtn = document.getElementById('addMarker');
const likeBtn = document.getElementById('likeBtn');
const downloadBtn = document.getElementById('downloadBtn');
const deleteBtn = document.getElementById('deleteBtn');
const commentsEl = document.getElementById('comments');
const commentInput = document.getElementById('commentInput');
const addCommentBtn = document.getElementById('addComment');
const closePlayerBtn = document.getElementById('closePlayer');
const toggleThemeBtn = document.getElementById('toggleTheme');
const exportMetaBtn = document.getElementById('exportMeta');
const importMetaBtn = document.getElementById('importMeta');
const cleanExpiredBtn = document.getElementById('cleanExpired');
const showAllBtn = document.getElementById('showAll');
const toggleTheaterBtn = document.getElementById('toggleTheater');
const togglePlaylistPlayBtn = document.getElementById('togglePlaylistPlay');

/* ================= Event wiring ================= */
fileInput.addEventListener('change', e => { addFiles(e.target.files); fileInput.value=''; });
document.addEventListener('dragover', e=>e.preventDefault());
document.addEventListener('drop', e=>{ e.preventDefault(); if(e.dataTransfer && e.dataTransfer.files) addFiles(e.dataTransfer.files); });

addQueueBtn.addEventListener('click', ()=> {
  // add currently selected files to queue (from last file input)
  if(!fileInput.files || fileInput.files.length===0){ alert('Bitte zuerst Dateien ausw√§hlen.'); return;}
  addFiles(fileInput.files);
  fileInput.value='';
});
startUploadBtn.addEventListener('click', startUpload);
clearQueueBtn.addEventListener('click', ()=>{ uploadQueue=[]; renderQueue(); });
searchInput.addEventListener('input', refreshGallery);
sortSelect.addEventListener('change', refreshGallery);
newPlaylistBtn.addEventListener('click', createPlaylist);
exportMetaBtn.addEventListener('click', exportMetadata);
importMetaBtn.addEventListener('click', importMetadata);
cleanExpiredBtn.addEventListener('click', async ()=>{ await removeExpired(); await refreshGallery(); alert('Abgelaufene wurden entfernt'); });
showAllBtn.addEventListener('click', refreshGallery);
toggleThemeBtn.addEventListener('click', toggleTheme);
toggleTheaterBtn.addEventListener('click', ()=> document.body.classList.toggle('theater'));
togglePlaylistPlayBtn.addEventListener('click', togglePlaylistPlay);

/* ================= Queue functions ================= */
function addFiles(fileList){
  const arr = Array.from(fileList).filter(f => f.type && f.type.startsWith('video'));
  if(arr.length===0){ alert('Keine Videodateien gefunden'); return; }
  arr.forEach(f => {
    uploadQueue.push({id: uid('q'), file: f, title: '', desc: '', ttl: parseInt(ttlSelect.value,10)});
  });
  renderQueue();
}
function renderQueue(){
  queueEl.innerHTML=''; queueSmall.innerHTML='';
  uploadQueue.forEach(item=>{
    const li = document.createElement('li'); li.textContent = `${item.file.name} ‚Ä¢ ${niceBytes(item.file.size)}`;
    queueEl.appendChild(li);
    const li2 = document.createElement('li'); li2.textContent = `${item.file.name}`;
    queueSmall.appendChild(li2);
  });
}

/* ================= Upload (store in IndexedDB) ================= */
async function startUpload(){
  if(uploadQueue.length===0){ alert('Queue ist leer'); return; }
  startUploadBtn.disabled = true;
  for(const q of uploadQueue){
    try{
      const file = q.file;
      const title = titleInput.value.trim() || file.name;
      const desc = descInput.value.trim() || '';
      const ttl = q.ttl || parseInt(ttlSelect.value,10);
      const createdAt = Date.now();
      const expireAt = ttl > 0 ? createdAt + ttl*3600000 : null;
      let thumb = null;
      try{ thumb = await captureThumbnail(file); }catch(e){ console.warn('Thumb failed', e); }
      const id = uid('v');
      const item = {
        id, title, description: desc, filename: file.name, size: file.size, type: file.type,
        createdAt, expireAt,
        thumbBlob: thumb ? await blobToArrayBuffer(thumb) : null,
        videoBlob: await blobToArrayBuffer(file),
        views: 0, likes: 0, comments: [], markers: [] // initial meta
      };
      await idbPut(STORE, item);
    }catch(e){
      console.error('Upload failed', e);
      alert('Fehler beim Upload: ' + e.message);
    }
  }
  uploadQueue = []; renderQueue();
  await refreshGallery();
  startUploadBtn.disabled = false;
}

/* helper: convert Blob to ArrayBuffer for safer storage in IDB (some browsers prefer blobs but IDB supports blobs ‚Äî but we normalize) */
function blobToArrayBuffer(blob){
  return new Promise((res,rej)=>{ const r=new FileReader(); r.onload=()=>res(r.result); r.onerror=()=>rej(r.error); r.readAsArrayBuffer(blob); });
}
function arrayBufferToBlob(ab, type){ return new Blob([ab], {type: type || 'application/octet-stream'}); }

/* ================= Gallery rendering ================= */
async function refreshGallery(){
  const all = await idbGetAll(STORE);
  const now = Date.now();
  const valid = all.filter(x => !x.expireAt || x.expireAt > now);
  const q = (searchInput.value || '').trim().toLowerCase();
  let filtered = valid.filter(v => {
    if(!q) return true;
    return (v.title||'').toLowerCase().includes(q) || (v.description||'').toLowerCase().includes(q);
  });
  const sort = sortSelect.value;
  filtered.sort((a,b)=>{
    if(sort==='new') return b.createdAt - a.createdAt;
    if(sort==='old') return a.createdAt - b.createdAt;
    if(sort==='title') return (a.title||'').localeCompare(b.title||'');
    if(sort==='views') return (b.views||0)-(a.views||0);
    if(sort==='likes') return (b.likes||0)-(a.likes||0);
    return b.createdAt - a.createdAt;
  });

  gallery.innerHTML='';
  let totSize = 0;
  filtered.forEach(item=>{
    totSize += item.size || 0;
    const card = document.createElement('div'); card.className='card';
    // thumbnail
    const img = document.createElement('img'); img.className='thumb';
    if(item.thumbBlob){
      const blob = arrayBufferToBlob(item.thumbBlob, 'image/jpeg');
      const url = URL.createObjectURL(blob);
      img.src = url;
    }else{
      // create objectURL for video
      if(!cacheURLs[item.id]){ cacheURLs[item.id] = URL.createObjectURL(arrayBufferToBlob(item.videoBlob, item.type)); }
      const v = document.createElement('video'); v.src = cacheURLs[item.id]; v.muted=true; v.loop=true; v.playsInline=true; v.autoplay=true; v.style.width='100%'; v.style.height='140px'; v.style.objectFit='cover';
      v.addEventListener('click', e=>{ e.stopPropagation(); openPlayer(item.id); });
      card.appendChild(v);
    }
    if(item.thumbBlob) { img.addEventListener('click', ()=> openPlayer(item.id)); card.appendChild(img); }

    const cb = document.createElement('div'); cb.className='card-body';
    cb.innerHTML = `<div class="title">${escapeHtml(item.title||item.filename||'Untitled')}</div>
      <div class="desc">${escapeHtml(item.description||'')}</div>`;
    const mr = document.createElement('div'); mr.className='meta-row';
    const left = document.createElement('div'); left.className='small'; left.textContent = `${fmtDate(item.createdAt)} ‚Ä¢ ${niceBytes(item.size||0)}`;
    const right = document.createElement('div'); right.className='controls';
    const playBtn = document.createElement('button'); playBtn.className='btn'; playBtn.textContent='‚ñ∂';
    playBtn.title='Abspielen'; playBtn.addEventListener('click', ()=> openPlayer(item.id));
    const dlBtn = document.createElement('button'); dlBtn.className='btn'; dlBtn.textContent='‚Üì'; dlBtn.title='Herunterladen'; dlBtn.addEventListener('click', ()=> downloadVideo(item.id));
    const addToPlaylistBtn = document.createElement('button'); addToPlaylistBtn.className='btn'; addToPlaylistBtn.textContent='ÔºãPlaylist'; addToPlaylistBtn.title='Zur Playlist hinzuf√ºgen';
    addToPlaylistBtn.addEventListener('click', ()=> choosePlaylistAndAdd(item.id));
    const delBtn = document.createElement('button'); delBtn.className='btn'; delBtn.textContent='‚úï'; delBtn.title='L√∂schen'; delBtn.addEventListener('click', async ()=>{ if(confirm('Video l√∂schen?')){ await idbDelete(STORE, item.id); cleanupURL(item.id); await refreshGallery(); }});
    const badge = document.createElement('span'); badge.className='playlist-badge'; badge.textContent = (item.views||0) + ' ‚ñ∂ ‚Ä¢ ' + (item.likes||0) + ' ‚ô•';
    right.appendChild(playBtn); right.appendChild(addToPlaylistBtn); right.appendChild(dlBtn); right.appendChild(delBtn);
    mr.appendChild(left); mr.appendChild(right);
    cb.appendChild(mr);
    cb.appendChild(badge);
    card.appendChild(cb);
    gallery.appendChild(card);
  });

  stats.textContent = `Videos: ${filtered.length} ‚Ä¢ Gesamtspeicher: ${niceBytes(totSize)}`;
}

/* escape helper */
function escapeHtml(s){ return String(s||'').replace(/[&<>"]/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[c])); }

/* cleanup objectURL */
function cleanupURL(id){ if(cacheURLs[id]){ try{ URL.revokeObjectURL(cacheURLs[id]); }catch(e){} delete cacheURLs[id]; } }

/* ================= Player modal functions ================= */
async function openPlayer(id){
  const item = await idbGet(STORE, id);
  if(!item){ alert('Video nicht gefunden'); return; }
  currentVideoId = id;
  // prepare objectURL
  if(!cacheURLs[id]) cacheURLs[id] = URL.createObjectURL(arrayBufferToBlob(item.videoBlob, item.type));
  playerVideo.src = cacheURLs[id];
  try{ playerVideo.currentTime = 0; }catch(e){}
  playerVideo.play().catch(()=>{});
  playerTitle.textContent = item.title || item.filename || 'Untitled';
  playerDesc.textContent = item.description || '';
  playerInfo.textContent = ` ‚Ä¢ ${fmtDate(item.createdAt)} ‚Ä¢ Ablauf: ${item.expireAt ? fmtDate(item.expireAt) : 'Nie'}`;
  playerStats.textContent = `Views: ${item.views || 0} ‚Ä¢ Likes: ${item.likes || 0}`;
  renderMarkers(item);
  renderComments(item);
  playerModal.style.display = 'flex';
  // increment view count
  item.views = (item.views||0) + 1;
  await idbPut(STORE, item);
  playerStats.textContent = `Views: ${item.views} ‚Ä¢ Likes: ${item.likes || 0}`;
}

/* close */
document.getElementById('closePlayer').addEventListener('click', closePlayer);
function closePlayer(){ playerModal.style.display='none'; try{ playerVideo.pause(); playerVideo.src=''; }catch(e){} currentVideoId=null; }

/* download */
async function downloadVideo(id){
  const item = await idbGet(STORE, id);
  if(!item) return;
  const url = cacheURLs[id] || URL.createObjectURL(arrayBufferToBlob(item.videoBlob, item.type));
  const a = document.createElement('a'); a.href = url; a.download = item.filename || (item.title||'video') + '.mp4'; document.body.appendChild(a); a.click(); a.remove();
}

/* delete */
deleteBtn.addEventListener('click', async ()=>{
  if(!currentVideoId) return;
  if(!confirm('Video l√∂schen?')) return;
  await idbDelete(STORE, currentVideoId);
  cleanupURL(currentVideoId);
  closePlayer();
  await refreshGallery();
});

/* ================= Markers ================= */
function renderMarkers(item){
  markerList.innerHTML = '';
  (item.markers || []).forEach((m, idx)=>{
    const div = document.createElement('div'); div.className='item';
    div.innerHTML = `<div style="flex:1"><strong>${escapeHtml(m.label||('Marker ' + (idx+1)))}</strong><div class="small">@ ${m.time}s</div></div>`;
    const btn = document.createElement('button'); btn.className='btn'; btn.textContent='‚§ì'; btn.title='Springen'; btn.addEventListener('click', ()=> { playerVideo.currentTime = m.time; });
    const del = document.createElement('button'); del.className='btn'; del.textContent='‚úï'; del.addEventListener('click', async ()=>{ item.markers.splice(idx,1); await idbPut(STORE, item); renderMarkers(item); });
    div.appendChild(btn); div.appendChild(del);
    markerList.appendChild(div);
  });
}
addMarkerBtn.addEventListener('click', async ()=>{
  if(!currentVideoId) return;
  const t = parseFloat(markerTime.value);
  const label = markerLabel.value.trim() || 'Marker';
  if(isNaN(t) || t < 0){ alert('Ung√ºltige Zeit'); return; }
  const item = await idbGet(STORE, currentVideoId);
  item.markers = item.markers || [];
  item.markers.push({time: t, label});
  await idbPut(STORE, item);
  markerTime.value = ''; markerLabel.value='';
  renderMarkers(item);
});

/* ================= Likes ================= */
likeBtn.addEventListener('click', async ()=>{
  if(!currentVideoId) return;
  const item = await idbGet(STORE, currentVideoId);
  item.likes = (item.likes||0) + 1;
  await idbPut(STORE, item);
  playerStats.textContent = `Views: ${item.views||0} ‚Ä¢ Likes: ${item.likes||0}`;
});

/* ================= Comments ================= */
function renderComments(item){
  commentsEl.innerHTML = '';
  (item.comments || []).slice().reverse().forEach(c=>{
    const div = document.createElement('div'); div.className='item';
    div.innerHTML = `<div style="flex:1"><strong>${escapeHtml(c.name||'User')}</strong><div class="small">${escapeHtml(c.text)}</div><div class="small">${fmtDate(c.ts)}</div></div>`;
    commentsEl.appendChild(div);
  });
}
addCommentBtn.addEventListener('click', async ()=>{
  if(!currentVideoId) return;
  const text = commentInput.value.trim();
  if(!text) return;
  const item = await idbGet(STORE, currentVideoId);
  item.comments = item.comments || [];
  item.comments.push({ name: 'Anon', text, ts: Date.now() });
  await idbPut(STORE, item);
  commentInput.value='';
  renderComments(item);
});

/* ================= Playlists ================= */
async function createPlaylist(){
  const name = prompt('Name der Playlist:','Neue Playlist');
  if(!name) return;
  const id = uid('pl');
  const pl = { id, name, items: [], createdAt: Date.now() };
  await idbPut(STORE_PLAYLISTS, pl);
  await renderPlaylists();
}
async function renderPlaylists(){
  const pls = await idbGetAll(STORE_PLAYLISTS);
  playlistsEl.innerHTML = '';
  pls.forEach(pl=>{
    const div = document.createElement('div'); div.className='panel'; div.style.marginBottom='8px';
    const title = document.createElement('div'); title.style.display='flex'; title.style.justifyContent='space-between';
    title.innerHTML = `<strong>${escapeHtml(pl.name)}</strong><div class="small">${(pl.items||[]).length} Videos</div>`;
    const list = document.createElement('div'); list.style.marginTop='8px';
    list.innerHTML = `<div class="small">${pl.items && pl.items.length ? pl.items.map(id=>id).slice(0,5).join(', ') : 'Keine Videos'}</div>`;
    const actions = document.createElement('div'); actions.style.display='flex'; actions.style.gap='6px'; actions.style.marginTop='8px';
    const playBtn = document.createElement('button'); playBtn.className='btn'; playBtn.textContent='‚ñ∂ Playlist'; playBtn.addEventListener('click', ()=> playPlaylist(pl.id));
    const delBtn = document.createElement('button'); delBtn.className='btn'; delBtn.textContent='‚úï'; delBtn.addEventListener('click', async ()=>{ if(confirm('Playlist l√∂schen?')){ await idbDelete(STORE_PLAYLISTS, pl.id); await renderPlaylists(); }});
    const renameBtn = document.createElement('button'); renameBtn.className='btn'; renameBtn.textContent='‚úé Rename'; renameBtn.addEventListener('click', async ()=>{ const nm = prompt('Neuer Name', pl.name); if(nm){ pl.name = nm; await idbPut(STORE_PLAYLISTS, pl); renderPlaylists(); }});
    actions.appendChild(playBtn); actions.appendChild(renameBtn); actions.appendChild(delBtn);
    div.appendChild(title); div.appendChild(list); div.appendChild(actions);
    div.addEventListener('click', ()=> openPlaylistEditor(pl.id), {capture:false});
    playlistsEl.appendChild(div);
  });
}
async function choosePlaylistAndAdd(videoId){
  const pls = await idbGetAll(STORE_PLAYLISTS);
  if(pls.length===0){ if(confirm('Keine Playlists ‚Äî neue erstellen?')) await createPlaylist(); else return; }
  const names = pls.map(p=>p.name).join('\\n');
  const sel = prompt('W√§hle Playlist (genauen Index eingeben):\\n' + pls.map((p,i)=>`${i}: ${p.name}`).join('\\n'));
  const idx = parseInt(sel,10);
  if(isNaN(idx) || idx<0 || idx>=pls.length) { alert('Ung√ºltige Auswahl'); return; }
  const pl = pls[idx];
  pl.items = pl.items || [];
  if(!pl.items.includes(videoId)) pl.items.push(videoId);
  await idbPut(STORE_PLAYLISTS, pl);
  alert('Video hinzugef√ºgt');
  await renderPlaylists();
}

/* playlist playback */
async function playPlaylist(plId){
  const pl = await idbGet(STORE_PLAYLISTS, plId);
  if(!pl || !pl.items || pl.items.length===0){ alert('Playlist leer'); return; }
  playingPlaylist = pl;
  playlistPlayingIndex = 0;
  await playPlaylistIndex(playlistPlayingIndex);
}
async function playPlaylistIndex(idx){
  if(!playingPlaylist) return;
  const vidId = playingPlaylist.items[idx];
  if(!vidId){ playingPlaylist = null; return; }
  await openPlayer(vidId);
  // when video ends, advance
  playerVideo.onended = async ()=> {
    playlistPlayingIndex++;
    if(playlistPlayingIndex < playingPlaylist.items.length) await playPlaylistIndex(playlistPlayingIndex);
    else playingPlaylist = null;
  };
}
function togglePlaylistPlay(){ if(playingPlaylist){ playingPlaylist = null; alert('Playlist abgebrochen'); } else { const plsPromise = idbGetAll(STORE_PLAYLISTS).then(pls=>{ if(pls.length===0) return alert('Keine Playlists vorhanden'); playPlaylist(pls[0].id); }); } }

/* Playlist editor (simple) */
async function openPlaylistEditor(plId){
  const pl = await idbGet(STORE_PLAYLISTS, plId);
  if(!pl) return;
  const names = (await idbGetAll(STORE)).map(v=>`${v.id}: ${v.title}`).join('\\n');
  const action = prompt(`Playlist: ${pl.name}\\nActions: add:<videoId> | remove:<videoId> | view | cancel\\n\nBeispiel add:${(await idbGetAll(STORE))[0]?.id || '...'}\\n\\nVideos:\\n${pl.items.join(',')}`);
  if(!action) return;
  if(action.startsWith('add:')){ const vid=action.slice(4); pl.items=pl.items||[]; if(!pl.items.includes(vid)) pl.items.push(vid); await idbPut(STORE_PLAYLISTS, pl); alert('Hinzugef√ºgt'); renderPlaylists(); }
  else if(action.startsWith('remove:')){ const vid=action.slice(7); pl.items = (pl.items||[]).filter(x=>x!==vid); await idbPut(STORE_PLAYLISTS, pl); alert('Entfernt'); renderPlaylists(); }
  else if(action==='view'){ alert('Videos: ' + (pl.items||[]).join('\\n')); }
}

/* ================= Export / Import metadata ================= */
async function exportMetadata(){
  const all = await idbGetAll(STORE);
  const safe = all.map(({id,title,description,filename,size,type,createdAt,expireAt,views,likes,comments,markers})=>({id,title,description,filename,size,type,createdAt,expireAt,views,likes,comments,markers}));
  const blob = new Blob([JSON.stringify(safe, null, 2)], {type:'application/json'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href = url; a.download = 'video_metadata.json'; document.body.appendChild(a); a.click(); a.remove();
  setTimeout(()=>URL.revokeObjectURL(url),5000);
}
async function importMetadata(){
  const f = document.createElement('input'); f.type='file'; f.accept='application/json'; f.addEventListener('change', async ()=> {
    const file = f.files[0]; if(!file) return;
    const txt = await file.text();
    try{
      const arr = JSON.parse(txt);
      if(!Array.isArray(arr)) throw new Error('Ung√ºltiges Format');
      // merge metadata; do not add blobs
      for(const m of arr){
        const existing = await idbGet(STORE, m.id);
        if(existing){
          existing.title = m.title || existing.title;
          existing.description = m.description || existing.description;
          existing.views = m.views || existing.views;
          existing.likes = m.likes || existing.likes;
          existing.markers = m.markers || existing.markers;
          existing.comments = m.comments || existing.comments;
          await idbPut(STORE, existing);
        }else{
          // create placeholder missing blob (user must re-upload)
          const placeholder = { id: m.id, title: m.title, description: m.description, filename: m.filename, size: m.size, type: m.type, createdAt: m.createdAt || Date.now(), expireAt: m.expireAt || null, views: m.views || 0, likes: m.likes || 0, comments: m.comments || [], markers: m.markers || [], videoBlob: null, thumbBlob: null };
          await idbPut(STORE, placeholder);
        }
      }
      alert('Metadaten importiert. Falls Videos fehlen m√ºssen die Dateien neu hochgeladen werden.');
      await refreshGallery();
    }catch(e){ alert('Import fehlgeschlagen: ' + e.message); }
  }); f.click();
}

/* ================= Expiration cleanup ================= */
async function removeExpired(){
  const all = await idbGetAll(STORE);
  const now = Date.now();
  const expired = all.filter(x => x.expireAt && x.expireAt <= now);
  for(const e of expired){
    await idbDelete(STORE, e.id);
    cleanupURL(e.id);
  }
  return expired.length;
}

/* ================= Theme handling ================= */
function toggleTheme(){
  const light = document.body.classList.toggle('light');
  if(light){
    document.documentElement.style.setProperty('--bg','#f5f7fb');
    document.documentElement.style.setProperty('--card','#ffffff');
    document.documentElement.style.setProperty('--muted','#56606a');
    document.documentElement.style.setProperty('--accent','#2563eb');
    document.documentElement.style.setProperty('--glass','rgba(0,0,0,0.04)');
  }else{
    document.documentElement.style.setProperty('--bg','#071028');
    document.documentElement.style.setProperty('--card','#0f1724');
    document.documentElement.style.setProperty('--muted','#98a4b3');
    document.documentElement.style.setProperty('--accent','#60a5fa');
    document.documentElement.style.setProperty('--glass','rgba(255,255,255,0.03)');
  }
}

/* ================= Helper: add video to playlist quick chooser ================= */
// implemented above as choosePlaylistAndAdd

/* ================= Initialization ================= */
(async function init(){
  await removeExpired();
  await refreshGallery();
  await renderPlaylists();
  // perf: revoke objectURLs on unload
  window.addEventListener('beforeunload', ()=> { Object.keys(cacheURLs).forEach(k=>{ try{ URL.revokeObjectURL(cacheURLs[k]); }catch(e){} }); });
})();

/* ================= Small UX helpers ================= */
// open player on double-clicks handled via click on thumbnail

/* ================= Extra: simple keyboard shortcuts ================= */
window.addEventListener('keydown', (e)=>{
  if((e.ctrlKey||e.metaKey) && e.key==='k'){ e.preventDefault(); document.getElementById('searchInput').focus(); }
});

/* ================= End of app ================= */
</script>
</body>
</html>
